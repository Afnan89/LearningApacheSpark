

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Text Mining &mdash; Learning Apache Spark with Python v1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Learning Apache Spark with Python v1.0 documentation" href="index.html"/>
        <link rel="next" title="Social Network Analysis" href="socialnetwork.html"/>
        <link rel="prev" title="Clustering" href="clustering.html"/>
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-168290-9']);
  _gaq.push(['_trackPageview']);
</script>


  
  <script src="static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Learning Apache Spark with Python
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="why.html">Why Spark with Python ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Configure Running Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">An Introduction to Apache Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="rdd.html">Programming with RDDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="stats.html">Statistics Preliminary</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression.html">Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification.html">Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="clustering.html">Clustering</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Text Mining</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#text-collection">Text Collection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#image-to-text">Image to text</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-enhnaced-to-text">Image Enhnaced to text</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pdf-to-text">PDF to text</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#text-preprocessing">Text Preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#text-classification">Text Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sentiment-analysis">Sentiment analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pipeline">Pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="#demo">Demo</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#n-grams-and-correlations">N-grams and Correlations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#topic-model-latent-dirichlet-allocation">Topic Model: Latent Dirichlet Allocation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="socialnetwork.html">Social Network Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="fnn.html">Neural Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Main Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Learning Apache Spark with Python</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Text Mining</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="sources/textmining.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="text-mining">
<span id="textmining"></span><h1>Text Mining<a class="headerlink" href="#text-mining" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Sharpening the knife longer can make it easier to hack the firewood &#8211; old Chinese proverb</p>
</div>
<div class="figure align-center">
<img alt="images/sen_word_freq.png" src="images/sen_word_freq.png" />
</div>
<div class="section" id="text-collection">
<h2>Text Collection<a class="headerlink" href="#text-collection" title="Permalink to this headline">¶</a></h2>
<div class="section" id="image-to-text">
<h3>Image to text<a class="headerlink" href="#image-to-text" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">img2txt</span><span class="p">(</span><span class="n">img_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert images to text</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">PythonMagick</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">import</span> <span class="nn">PyPDF2</span>

    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="kn">import</span> <span class="nn">pytesseract</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;doc4img.txt&#39;</span><span class="p">,</span><span class="s1">&#39;wa&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">[</span><span class="n">img_file</span> <span class="k">for</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">img_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">img_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpeg&quot;</span><span class="p">))]:</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">input_img</span> <span class="o">=</span> <span class="n">img_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">img</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Converting &#39;</span> <span class="o">+</span> <span class="n">img</span> <span class="o">+</span><span class="s1">&#39;.......&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>

        <span class="c1"># extract the text information from images</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_img</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># ouput text file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">img</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


        <span class="k">print</span> <span class="s2">&quot;CPU Time for converting&quot;</span> <span class="o">+</span> <span class="n">img</span> <span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="image-enhnaced-to-text">
<h3>Image Enhnaced to text<a class="headerlink" href="#image-enhnaced-to-text" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pdf2txt_enhance</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span><span class="n">scaler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert images files to text</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">PythonMagick</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">import</span> <span class="nn">PyPDF2</span>

    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageEnhance</span><span class="p">,</span> <span class="n">ImageFilter</span>
    <span class="kn">import</span> <span class="nn">pytesseract</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;doc4img.txt&#39;</span><span class="p">,</span><span class="s1">&#39;wa&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">[</span><span class="n">img_file</span> <span class="k">for</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">img_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">img_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpeg&quot;</span><span class="p">))]:</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">input_img</span> <span class="o">=</span> <span class="n">img_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">img</span>
        <span class="n">enhanced_img</span> <span class="o">=</span> <span class="n">img_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span><span class="s2">&quot;Enhanced&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">+</span> <span class="n">img</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">input_img</span><span class="p">)</span> <span class="c1"># the second one</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">MedianFilter</span><span class="p">())</span>
        <span class="n">enhancer</span> <span class="o">=</span> <span class="n">ImageEnhance</span><span class="o">.</span><span class="n">Contrast</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">enhancer</span><span class="o">.</span><span class="n">enhance</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">enhanced_img</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">scaler</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">enhanced_img</span><span class="p">)</span> <span class="c1"># the second one</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">MedianFilter</span><span class="p">())</span>
            <span class="n">enhancer</span> <span class="o">=</span> <span class="n">ImageEnhance</span><span class="o">.</span><span class="n">Contrast</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">enhancer</span><span class="o">.</span><span class="n">enhance</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">enhanced_img</span><span class="p">)</span>



        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Converting &#39;</span> <span class="o">+</span> <span class="n">img</span> <span class="o">+</span><span class="s1">&#39;.......&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>

        <span class="c1"># extract the text information from images</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">enhanced_img</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># ouput text file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">img</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


        <span class="k">print</span> <span class="s2">&quot;CPU Time for converting&quot;</span> <span class="o">+</span> <span class="n">img</span> <span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="pdf-to-text">
<h3>PDF to text<a class="headerlink" href="#pdf-to-text" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pdf2txt</span><span class="p">(</span><span class="n">pdf_dir</span><span class="p">,</span><span class="n">image_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert PDF to text</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">PythonMagick</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">import</span> <span class="nn">PyPDF2</span>

    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="kn">import</span> <span class="nn">pytesseract</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;doc.txt&#39;</span><span class="p">,</span><span class="s1">&#39;wa&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pdf</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pdf_file</span> <span class="k">for</span> <span class="n">pdf_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pdf_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">pdf_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)]:</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">input_pdf</span> <span class="o">=</span> <span class="n">pdf_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">pdf</span>

        <span class="n">pdf_im</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="o">.</span><span class="n">PdfFileReader</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="n">input_pdf</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
        <span class="n">npage</span> <span class="o">=</span> <span class="n">pdf_im</span><span class="o">.</span><span class="n">getNumPages</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Converting </span><span class="si">%d</span><span class="s1"> pages.&#39;</span> <span class="o">%</span> <span class="n">npage</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npage</span><span class="p">):</span>

            <span class="n">pdf_file</span> <span class="o">=</span> <span class="n">input_pdf</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;]&#39;</span>
            <span class="n">image_file</span> <span class="o">=</span>  <span class="n">image_dir</span>  <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">pdf</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.png&#39;</span>

            <span class="c1"># convert PDF files to Images</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">PythonMagick</span><span class="o">.</span><span class="n">Image</span><span class="p">()</span>
            <span class="n">im</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="s1">&#39;300&#39;</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>

            <span class="c1"># extract the text information from images</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>

            <span class="c1">#print(text)</span>

            <span class="c1"># ouput text file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">pdf</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


        <span class="k">print</span> <span class="s2">&quot;CPU Time for converting&quot;</span> <span class="o">+</span> <span class="n">pdf</span> <span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="text-preprocessing">
<h2>Text Preprocessing<a class="headerlink" href="#text-preprocessing" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>check to see if a row only contains whitespace</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_blanks</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="n">is_blank</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_str</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">is_blank</span>
</pre></div>
</div>
<ul class="simple">
<li>Determine whether the language of the text content is english or not: Use langid module to classify the language to make sure we are applying the correct cleanup actions for English langid</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_lang</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="n">predict_lang</span> <span class="o">=</span> <span class="n">langid</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">data_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">predict_lang</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">predict_lang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
    <span class="k">return</span> <span class="n">language</span>
</pre></div>
</div>
<ul class="simple">
<li>Remove features</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_features</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="c1"># compile regex</span>
    <span class="n">url_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;https?://(www.)?\w+\.\w+(/\w+)*/?&#39;</span><span class="p">)</span>
    <span class="n">punc_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">))</span>
    <span class="n">num_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(</span><span class="se">\\</span><span class="s1">d+)&#39;</span><span class="p">)</span>
    <span class="n">mention_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;@(\w+)&#39;</span><span class="p">)</span>
    <span class="n">alpha_num_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^[a-z0-9_.]+$&quot;</span><span class="p">)</span>
    <span class="c1"># convert to lowercase</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># remove hyperlinks</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">url_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove @mentions</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">mention_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove puncuation</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">punc_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove numeric &#39;words&#39;</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">num_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove non a-z 0-9 characters and words shorter than 3 characters</span>
    <span class="n">list_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">list_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alpha_num_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alpha_num_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">cleaned_str</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
        <span class="n">list_pos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">cleaned_str</span>
</pre></div>
</div>
<ul class="simple">
<li>removes stop words</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_stops</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="c1"># expects a string</span>
    <span class="n">stops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">))</span>
    <span class="n">list_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stops</span><span class="p">:</span>
            <span class="c1"># rebuild cleaned_str</span>
            <span class="k">if</span> <span class="n">list_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">cleaned_str</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">word</span>
            <span class="n">list_pos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">cleaned_str</span>
</pre></div>
</div>
<ul class="simple">
<li>tagging text</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tag_and_remove</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="c1"># noun tags</span>
    <span class="n">nn_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="s1">&#39;NNP&#39;</span><span class="p">,</span> <span class="s1">&#39;NNP&#39;</span><span class="p">,</span> <span class="s1">&#39;NNPS&#39;</span><span class="p">,</span> <span class="s1">&#39;NNS&#39;</span><span class="p">]</span>
    <span class="c1"># adjectives</span>
    <span class="n">jj_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;JJ&#39;</span><span class="p">,</span> <span class="s1">&#39;JJR&#39;</span><span class="p">,</span> <span class="s1">&#39;JJS&#39;</span><span class="p">]</span>
    <span class="c1"># verbs</span>
    <span class="n">vb_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VB&#39;</span><span class="p">,</span> <span class="s1">&#39;VBD&#39;</span><span class="p">,</span> <span class="s1">&#39;VBG&#39;</span><span class="p">,</span> <span class="s1">&#39;VBN&#39;</span><span class="p">,</span> <span class="s1">&#39;VBP&#39;</span><span class="p">,</span> <span class="s1">&#39;VBZ&#39;</span><span class="p">]</span>
    <span class="n">nltk_tags</span> <span class="o">=</span> <span class="n">nn_tags</span> <span class="o">+</span> <span class="n">jj_tags</span> <span class="o">+</span> <span class="n">vb_tags</span>

    <span class="c1"># break string into &#39;words&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># tag the text and keep only those with the right tags</span>
    <span class="n">tagged_text</span> <span class="o">=</span> <span class="n">pos_tag</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tagged_word</span> <span class="ow">in</span> <span class="n">tagged_text</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tagged_word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">nltk_tags</span><span class="p">:</span>
            <span class="n">cleaned_str</span> <span class="o">+=</span> <span class="n">tagged_word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="k">return</span> <span class="n">cleaned_str</span>
</pre></div>
</div>
<ul class="simple">
<li>lemmatization</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lemmatize</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="c1"># expects a string</span>
    <span class="n">list_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">lmtzr</span> <span class="o">=</span> <span class="n">WordNetLemmatizer</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">tagged_words</span> <span class="o">=</span> <span class="n">pos_tag</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tagged_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;v&#39;</span> <span class="ow">in</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">lemma</span> <span class="o">=</span> <span class="n">lmtzr</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lemma</span> <span class="o">=</span> <span class="n">lmtzr</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">list_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">lemma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">cleaned_str</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">lemma</span>
        <span class="n">list_pos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">cleaned_str</span>
</pre></div>
</div>
<p><strong>define the preprocessing function in PySpark</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span>
<span class="kn">import</span> <span class="nn">preproc</span> <span class="kn">as</span> <span class="nn">pp</span>

<span class="n">check_lang_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">check_lang</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">remove_stops_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">remove_stops</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">remove_features_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">remove_features</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">tag_and_remove_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">tag_and_remove</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">lemmatize_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
<span class="n">check_blanks_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">check_blanks</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="text-classification">
<h2>Text Classification<a class="headerlink" href="#text-classification" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nltk.stem.wordnet</span> <span class="kn">import</span> <span class="n">WordNetLemmatizer</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk</span> <span class="kn">import</span> <span class="n">pos_tag</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">langid</span>
</pre></div>
</div>
</div>
<div class="section" id="sentiment-analysis">
<h2>Sentiment analysis<a class="headerlink" href="#sentiment-analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Sentiment_analysis">Sentiment analysis</a> (sometimes known as opinion mining or emotion AI) refers to the use of natural language processing, text analysis, computational linguistics, and biometrics to systematically identify, extract, quantify, and study affective states and subjective information. Sentiment analysis is widely applied to voice of the customer materials such as reviews and survey responses, online and social media, and healthcare materials for applications that range from marketing to customer service to clinical medicine.</p>
<p>Generally speaking, sentiment analysis aims to <strong>determine the attitude</strong> of a speaker, writer, or other subject with respect to some topic or the overall contextual polarity or emotional reaction to a document, interaction, or event. The attitude may be a judgment or evaluation (see appraisal theory), affective state (that is to say, the emotional state of the author or speaker), or the intended emotional communication (that is to say, the emotional effect intended by the author or interlocutor).</p>
<p>Sentiment analysis in business, also known as opinion mining is a process of identifying and cataloging a piece of text according to the tone conveyed by it. It has broad application:</p>
<ul class="simple">
<li>Sentiment Analysis in Business Intelligence Build up</li>
<li>Sentiment Analysis in Business for Competitive Advantage</li>
<li>Enhancing the Customer Experience through Sentiment Analysis in Business</li>
</ul>
</div>
<div class="section" id="pipeline">
<h3>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id2">
<span id="fig-sa-pipeline"></span><img alt="images/sentiment_analysis_pipeline.png" src="images/sentiment_analysis_pipeline.png" />
<p class="caption"><span class="caption-number">Fig. 23 </span><span class="caption-text">Sentiment Analysis Pipeline</span></p>
</div>
</div>
<div class="section" id="demo">
<h3>Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Set up spark context and SparkSession</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
    <span class="o">.</span><span class="n">builder</span> \
    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Python Spark Sentiment Analysis example&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.some.config.option&quot;</span><span class="p">,</span> <span class="s2">&quot;some-value&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Load dataset</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;com.databricks.spark.csv&#39;</span><span class="p">)</span><span class="o">.</span>\
                               <span class="n">options</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> \
                               <span class="n">inferschema</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/newtwitter.csv&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+----------+-------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span>        <span class="nb">id</span><span class="o">|</span><span class="n">pubdate</span><span class="o">|</span>
<span class="o">+--------------------+----------+-------+</span>
<span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span><span class="mi">2602860537</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span><span class="mi">2602850443</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span><span class="mi">2602761852</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span>
<span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602738438</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span>
<span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602684185</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span>
<span class="o">+--------------------+----------+-------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Text Preprocessing</li>
</ol>
<ul class="simple">
<li>remove non ASCII characters</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span>

<span class="kn">from</span> <span class="nn">nltk.stem.wordnet</span> <span class="kn">import</span> <span class="n">WordNetLemmatizer</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk</span> <span class="kn">import</span> <span class="n">pos_tag</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># remove non ASCII characters</span>
<span class="k">def</span> <span class="nf">strip_non_ascii</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Returns the string without non ASCII characters&#39;&#39;&#39;</span>
    <span class="n">stripped</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_str</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span>
<span class="c1"># setup pyspark udf function</span>
<span class="n">strip_non_ascii_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">strip_non_ascii</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<p>check:
.. code-block:: python</p>
<blockquote>
<div>df = df.withColumn(&#8216;text_non_asci&#8217;,strip_non_ascii_udf(df[&#8216;text&#8217;]))
df.show(5,True)</div></blockquote>
<p>ouput:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+----------+-------+--------------------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span>        <span class="nb">id</span><span class="o">|</span><span class="n">pubdate</span><span class="o">|</span>       <span class="n">text_non_asci</span><span class="o">|</span>
<span class="o">+--------------------+----------+-------+--------------------+</span>
<span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span><span class="mi">2602860537</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span><span class="mi">2602850443</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span><span class="mi">2602761852</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span>
<span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602738438</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span>
<span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602684185</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span>
<span class="o">+--------------------+----------+-------+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li>fixed abbreviation</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># fixed abbreviation</span>
<span class="k">def</span> <span class="nf">fix_abbreviation</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bthats\b&#39;</span><span class="p">,</span> <span class="s1">&#39;that is&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bive\b&#39;</span><span class="p">,</span> <span class="s1">&#39;i have&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bim\b&#39;</span><span class="p">,</span> <span class="s1">&#39;i am&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bya\b&#39;</span><span class="p">,</span> <span class="s1">&#39;yeah&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bcant\b&#39;</span><span class="p">,</span> <span class="s1">&#39;can not&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bdont\b&#39;</span><span class="p">,</span> <span class="s1">&#39;do not&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bwont\b&#39;</span><span class="p">,</span> <span class="s1">&#39;will not&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bid\b&#39;</span><span class="p">,</span> <span class="s1">&#39;i would&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;wtf&#39;</span><span class="p">,</span> <span class="s1">&#39;what the fuck&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bwth\b&#39;</span><span class="p">,</span> <span class="s1">&#39;what the hell&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\br\b&#39;</span><span class="p">,</span> <span class="s1">&#39;are&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bu\b&#39;</span><span class="p">,</span> <span class="s1">&#39;you&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bk\b&#39;</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bsux\b&#39;</span><span class="p">,</span> <span class="s1">&#39;sucks&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bno+\b&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bcoo+\b&#39;</span><span class="p">,</span> <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;rt\b&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data_str</span>

<span class="n">fix_abbreviation_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">fix_abbreviation</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<dl class="docutils">
<dt>check:</dt>
<dd><div class="first last highlight-python"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;fixed_abbrev&#39;</span><span class="p">,</span><span class="n">fix_abbreviation_udf</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;text_non_asci&#39;</span><span class="p">]))</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p>ouput:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+----------+-------+--------------------+--------------------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span>        <span class="nb">id</span><span class="o">|</span><span class="n">pubdate</span><span class="o">|</span>       <span class="n">text_non_asci</span><span class="o">|</span>        <span class="n">fixed_abbrev</span><span class="o">|</span>
<span class="o">+--------------------+----------+-------+--------------------+--------------------+</span>
<span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span><span class="mi">2602860537</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span><span class="mi">10</span> <span class="n">things</span> <span class="n">missing</span><span class="o">...|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span><span class="mi">2602850443</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span><span class="nd">@_naturalbwinner</span> <span class="o">...|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span><span class="mi">2602761852</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span><span class="nd">@hbo24</span> <span class="n">yo</span> <span class="n">the</span> <span class="c1">#ne...|</span>
<span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602738438</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span><span class="n">aaaaaaaand</span> <span class="n">i</span> <span class="n">have</span><span class="o">...|</span>
<span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602684185</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="n">can</span> <span class="n">i</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span>
<span class="o">+--------------------+----------+-------+--------------------+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li>remove irrelevant features</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_features</span><span class="p">(</span><span class="n">data_str</span><span class="p">):</span>
    <span class="c1"># compile regex</span>
    <span class="n">url_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;https?://(www.)?\w+\.\w+(/\w+)*/?&#39;</span><span class="p">)</span>
    <span class="n">punc_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">))</span>
    <span class="n">num_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(</span><span class="se">\\</span><span class="s1">d+)&#39;</span><span class="p">)</span>
    <span class="n">mention_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;@(\w+)&#39;</span><span class="p">)</span>
    <span class="n">alpha_num_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^[a-z0-9_.]+$&quot;</span><span class="p">)</span>
    <span class="c1"># convert to lowercase</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># remove hyperlinks</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">url_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove @mentions</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">mention_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove puncuation</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">punc_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove numeric &#39;words&#39;</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">num_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    <span class="c1"># remove non a-z 0-9 characters and words shorter than 1 characters</span>
    <span class="n">list_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">list_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alpha_num_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alpha_num_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">=</span> <span class="n">cleaned_str</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">word</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cleaned_str</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
        <span class="n">list_pos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># remove unwanted space, *.split() will automatically split on</span>
    <span class="c1"># whitespace and discard duplicates, the &quot; &quot;.join() joins the</span>
    <span class="c1"># resulting list into one string.</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_str</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="c1"># setup pyspark udf function</span>
<span class="n">remove_features_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">remove_features</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<dl class="docutils">
<dt>check:</dt>
<dd><div class="first last highlight-python"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;removed&#39;</span><span class="p">,</span><span class="n">remove_features_udf</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fixed_abbrev&#39;</span><span class="p">]))</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
<p>ouput:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+----------+-------+--------------------+--------------------+--------------------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span>        <span class="nb">id</span><span class="o">|</span><span class="n">pubdate</span><span class="o">|</span>       <span class="n">text_non_asci</span><span class="o">|</span>        <span class="n">fixed_abbrev</span><span class="o">|</span>             <span class="n">removed</span><span class="o">|</span>
<span class="o">+--------------------+----------+-------+--------------------+--------------------+--------------------+</span>
<span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span><span class="mi">2602860537</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span><span class="mi">10</span> <span class="n">Things</span> <span class="n">Missing</span><span class="o">...|</span><span class="mi">10</span> <span class="n">things</span> <span class="n">missing</span><span class="o">...|</span><span class="n">things</span> <span class="n">missing</span> <span class="ow">in</span><span class="o">...|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span><span class="mi">2602850443</span><span class="o">|</span>  <span class="mi">18536</span><span class="o">|</span><span class="n">RT</span> <span class="nd">@_NATURALBWINN...</span><span class="o">|</span><span class="nd">@_naturalbwinner</span> <span class="o">...|</span><span class="n">oh</span> <span class="ow">and</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">lik</span><span class="o">...|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span><span class="mi">2602761852</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">RT</span> <span class="nd">@HBO24</span> <span class="n">yo</span> <span class="n">the</span> <span class="o">...|</span><span class="nd">@hbo24</span> <span class="n">yo</span> <span class="n">the</span> <span class="c1">#ne...|yo the newtwitter...|</span>
<span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602738438</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">Aaaaaaaand</span> <span class="n">I</span> <span class="n">have</span><span class="o">...|</span><span class="n">aaaaaaaand</span> <span class="n">i</span> <span class="n">have</span><span class="o">...|</span><span class="n">aaaaaaaand</span> <span class="n">have</span> <span class="n">t</span><span class="o">...|</span>
<span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="mi">2602684185</span><span class="o">|</span>  <span class="mi">18535</span><span class="o">|</span><span class="n">can</span> <span class="n">I</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="n">can</span> <span class="n">i</span> <span class="n">please</span> <span class="n">have</span><span class="o">...|</span><span class="n">can</span> <span class="n">please</span> <span class="n">have</span> <span class="n">t</span><span class="o">...|</span>
<span class="o">+--------------------+----------+-------+--------------------+--------------------+--------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Sentiment Analysis  main function</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span>

<span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>

<span class="k">def</span> <span class="nf">sentiment_analysis</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span>

<span class="n">sentiment_analysis_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">sentiment_analysis</span> <span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">df</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;sentiment_score&quot;</span><span class="p">,</span> <span class="n">sentiment_analysis_udf</span><span class="p">(</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Sentiment score</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+---------------+</span>
<span class="o">|</span>             <span class="n">removed</span><span class="o">|</span><span class="n">sentiment_score</span><span class="o">|</span>
<span class="o">+--------------------+---------------+</span>
<span class="o">|</span><span class="n">things</span> <span class="n">missing</span> <span class="ow">in</span><span class="o">...|</span>    <span class="o">-</span><span class="mf">0.03181818</span><span class="o">|</span>
<span class="o">|</span><span class="n">oh</span> <span class="ow">and</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">lik</span><span class="o">...|</span>    <span class="o">-</span><span class="mf">0.03181818</span><span class="o">|</span>
<span class="o">|</span><span class="n">yo</span> <span class="n">the</span> <span class="n">newtwitter</span><span class="o">...|</span>      <span class="mf">0.3181818</span><span class="o">|</span>
<span class="o">|</span><span class="n">aaaaaaaand</span> <span class="n">have</span> <span class="n">t</span><span class="o">...|</span>     <span class="mf">0.11818182</span><span class="o">|</span>
<span class="o">|</span><span class="n">can</span> <span class="n">please</span> <span class="n">have</span> <span class="n">t</span><span class="o">...|</span>     <span class="mf">0.13636364</span><span class="o">|</span>
<span class="o">+--------------------+---------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li>Words frequency</li>
</ul>
<div class="figure align-center">
<img alt="images/sen_word_freq.png" src="images/sen_word_freq.png" />
</div>
<ul class="simple">
<li>Sentiment Classification</li>
</ul>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;positive&quot;</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;negative&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;neutral&quot;</span>
    <span class="k">return</span> <span class="n">label</span>

<span class="n">sentiment_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">condition</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="5">
<li>Output</li>
</ol>
<ul class="simple">
<li>Sentiment Class</li>
</ul>
<div class="figure align-center">
<img alt="images/sen_class.png" src="images/sen_class.png" />
</div>
<ul class="simple">
<li>Top tweets from each sentiment class</li>
</ul>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+---------------+---------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span><span class="n">sentiment_score</span><span class="o">|</span><span class="n">sentiment</span><span class="o">|</span>
<span class="o">+--------------------+---------------+---------+</span>
<span class="o">|</span><span class="ow">and</span> <span class="n">this</span> <span class="c1">#newtwit...|            1.0| positive|</span>
<span class="o">|</span><span class="s2">&quot;RT @SarahsJokes:...|            1.0| positive|</span>
<span class="o">|</span><span class="c1">#newtwitter using...|            1.0| positive|</span>
<span class="o">|</span><span class="n">The</span> <span class="c1">#NewTwitter h...|            1.0| positive|</span>
<span class="o">|</span><span class="n">You</span> <span class="n">can</span> <span class="n">now</span> <span class="n">undo</span> <span class="o">...|</span>            <span class="mf">1.0</span><span class="o">|</span> <span class="n">positive</span><span class="o">|</span>
<span class="o">+--------------------+---------------+---------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+---------------+---------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span><span class="n">sentiment_score</span><span class="o">|</span><span class="n">sentiment</span><span class="o">|</span>
<span class="o">+--------------------+---------------+---------+</span>
<span class="o">|</span><span class="n">Lists</span> <span class="n">on</span> <span class="c1">#NewTwit...|           -0.1|  neutral|</span>
<span class="o">|</span><span class="n">Too</span> <span class="n">bad</span> <span class="n">most</span> <span class="n">of</span> <span class="n">m</span><span class="o">...|</span>           <span class="o">-</span><span class="mf">0.1</span><span class="o">|</span>  <span class="n">neutral</span><span class="o">|</span>
<span class="o">|</span><span class="n">the</span> <span class="c1">#newtwitter i...|           -0.1|  neutral|</span>
<span class="o">|</span><span class="n">Looks</span> <span class="n">like</span> <span class="n">our</span> <span class="n">re</span><span class="o">...|</span>           <span class="o">-</span><span class="mf">0.1</span><span class="o">|</span>  <span class="n">neutral</span><span class="o">|</span>
<span class="o">|</span><span class="n">i</span> <span class="n">switched</span> <span class="n">to</span> <span class="n">the</span><span class="o">...|</span>           <span class="o">-</span><span class="mf">0.1</span><span class="o">|</span>  <span class="n">neutral</span><span class="o">|</span>
<span class="o">+--------------------+---------------+---------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="o">+--------------------+---------------+---------+</span>
<span class="o">|</span>                <span class="n">text</span><span class="o">|</span><span class="n">sentiment_score</span><span class="o">|</span><span class="n">sentiment</span><span class="o">|</span>
<span class="o">+--------------------+---------------+---------+</span>
<span class="o">|</span><span class="n">oh</span><span class="o">.</span> <span class="c1">#newtwitter i...|           -1.0| negative|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@chqwn</span><span class="p">:</span> <span class="c1">#NewTw...|           -1.0| negative|</span>
<span class="o">|</span><span class="n">Copy</span> <span class="n">that</span> <span class="o">-</span> <span class="n">its</span> <span class="n">W</span><span class="o">...|</span>           <span class="o">-</span><span class="mf">1.0</span><span class="o">|</span> <span class="n">negative</span><span class="o">|</span>
<span class="o">|</span><span class="n">RT</span> <span class="nd">@chqwn</span><span class="p">:</span> <span class="c1">#NewTw...|           -1.0| negative|</span>
<span class="o">|</span><span class="c1">#NewTwitter has t...|           -1.0| negative|</span>
<span class="o">+--------------------+---------------+---------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="n-grams-and-correlations">
<h2>N-grams and Correlations<a class="headerlink" href="#n-grams-and-correlations" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="topic-model-latent-dirichlet-allocation">
<h2>Topic Model: Latent Dirichlet Allocation<a class="headerlink" href="#topic-model-latent-dirichlet-allocation" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="socialnetwork.html" class="btn btn-neutral float-right" title="Social Network Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="clustering.html" class="btn btn-neutral" title="Clustering" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Wenqiang Feng.
      Last updated on Sep 25, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'v1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="static/jquery.js"></script>
      <script type="text/javascript" src="static/underscore.js"></script>
      <script type="text/javascript" src="static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>


</body>
</html>